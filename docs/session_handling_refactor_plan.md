# Session Handling Refactor Plan

## 1. Background and Problem Statement

Currently, there's a mismatch in session ID handling between the SvelteKit frontend and the Rust (Axum) backend, leading to session validation failures.

*   **Login (`POST /api/auth/login`):** Uses `axum-login` which sets a session cookie via `tower-sessions`. The session ID (let's call it `tower_session_id`) is generated by `tower-sessions` and stored in the `sessions` table.
*   **Frontend Validation:** The SvelteKit frontend's `validateSessionToken` function (in `src/lib/server/auth/index.ts`) takes the raw `tower_session_id` from the cookie, SHA256 hashes it (creating `frontend_hashed_session_id`), and then calls `GET /api/auth/session/:id` with this `frontend_hashed_session_id`.
*   **Backend Validation (`GET /api/auth/session/:id`):** The `get_session_handler` in `backend/src/routes/auth.rs` queries the `sessions` table for `frontend_hashed_session_id`. This ID does not match the `tower_session_id` stored by `axum-login`, resulting in a 404 error.
*   **Non-JSON 404:** The 404 error returned by `get_session_handler` is not a JSON response, causing a parsing error in the frontend's `apiClient` before the 404 status can be gracefully handled.
*   **Unused Endpoint:** The `POST /api/auth/session` (`create_session_handler`) which *would* store sessions by a client-provided (potentially hashed) ID is not called by the frontend in the current login flow.

## 2. Proposed Solution

The solution aims to unify session handling by leveraging `axum-login`'s mechanisms more directly for session validation and ensuring proper JSON error responses.

### 2.1. Backend Changes (Rust - Axum)

**Target File:** [`backend/src/routes/auth.rs`](backend/src/routes/auth.rs)

1.  **Modify `get_session_handler` and its Route:**
    *   **Route Change:** The API endpoint for validating the current session will be changed from `GET /api/auth/session/:id` to **`GET /api/auth/session/current`**.
    *   **Handler Signature:** The `get_session_handler` signature will be updated to remove the `Path(session_id): Path<String>` parameter. It will instead rely on the `AuthSession` extractor:
        ```rust
        // Old signature (example):
        // pub async fn get_session_handler(State(state): State<AppState>, Path(session_id): Path<String>) -> Result<impl IntoResponse, AppError>
        
        // New signature (example):
        pub async fn get_session_handler(State(state): State<AppState>, auth_session: AuthSession<AuthBackend>) -> Result<impl IntoResponse, AppError> 
        ```
    *   **Logic:**
        *   If `auth_session.user` is `Some(user)`, this indicates `axum-login` successfully validated the session cookie. The handler will construct and return a `SessionWithUserResponse` (or similar, containing relevant user and session details) with an HTTP 200 OK status.
        *   If `auth_session.user` is `None`, it means no valid session was found (not present, invalid, or expired). The handler will return an appropriate `AppError` (e.g., `AppError::Unauthorized("No active session")`).

2.  **Ensure JSON Error Responses:**
    *   Review and, if necessary, update the `IntoResponse` implementation for `AppError` (specifically for variants like `AppError::Unauthorized` or any new variant created for "no active session").
    *   Ensure that these errors are serialized into a JSON format (e.g., `{"error": "No active session"}`) and returned with the correct HTTP status code (e.g., 401 Unauthorized or 404 Not Found).

### 2.2. Frontend Changes (SvelteKit)

1.  **Update `apiClient.getSession`:**
    *   **Target File:** [`frontend/src/lib/api/index.ts`](frontend/src/lib/api/index.ts)
    *   The `getSession` method will be modified to call the new backend endpoint: `GET /api/auth/session/current`.
    *   It will no longer accept or require a `sessionId` parameter.
        ```typescript
        // Old signature (example):
        // async getSession(sessionId: string, fetchFn: typeof fetch = globalThis.fetch): Promise<Result<SessionResponse, ApiError>>
        
        // New signature (example):
        async getSession(fetchFn: typeof fetch = globalThis.fetch): Promise<Result<SessionResponse, ApiError>> {
            return this.fetch<SessionResponse>('/api/auth/session/current', {}, fetchFn);
        }
        ```

2.  **Update `validateSessionToken`:**
    *   **Target File:** [`frontend/src/lib/server/auth/index.ts`](frontend/src/lib/server/auth/index.ts)
    *   This function will no longer hash the session token obtained from the cookie.
    *   It will call the updated `apiClient.getSession()` (which no longer takes an ID).
        ```typescript
        // Snippet from old logic:
        // const sessionId = encodeHexLowerCase(sha256(new TextEncoder().encode(token)));
        // const sessionResult = await apiClient.getSession(sessionId, fetchFn);

        // Snippet for new logic:
        const sessionResult = await apiClient.getSession(fetchFn); 
        ```
    *   The rest of its error handling and response processing logic will remain largely the same, but will now correctly parse JSON error responses from the backend.

### 2.3. Deprecate/Remove Unused Code (Future Consideration)

*   The backend handlers in [`backend/src/routes/auth.rs`](backend/src/routes/auth.rs) related to manual session management via an ID (e.g., `create_session_handler`, the old `get_session_handler` logic, `extend_session_handler`, `delete_session_handler`) should be reviewed. If they are confirmed to be entirely unused after this refactor, they should be removed to simplify the codebase and prevent confusion. This step is secondary to fixing the primary session validation flow.

## 3. Visual Plan (Mermaid Diagram)

```mermaid
sequenceDiagram
    participant FE as Frontend (SvelteKit Hooks)
    participant AC as APIClient
    participant BE_Login as Backend (/api/auth/login)
    participant AxumLogin as Axum-Login Middleware
    participant TowerSessions as Tower-Sessions
    participant SessionStore as DieselSessionStore (sessions table)
    participant BE_VerifySess as Backend (/api/auth/session/current)

    Note over FE, BE_VerifySess: Proposed Corrected & Refined Flow

    Browser->>+BE_Login: POST /api/auth/login (credentials)
    BE_Login->>+AxumLogin: Authenticate user
    AxumLogin->>AxumLogin: User OK
    AxumLogin->>+TowerSessions: Create session
    TowerSessions->>+SessionStore: Store session data (keyed by tower_session_id)
    SessionStore-->>-TowerSessions: Session stored
    TowerSessions-->>-AxumLogin: Session created
    AxumLogin-->>BE_Login: Login OK
    BE_Login-->>-Browser: Set session cookie (value is tower_session_id)

    FE->>+AC: validateSessionToken(rawCookieTokenFromBrowser)
    AC->>+BE_VerifySess: GET /api/auth/session/current
    Note over BE_VerifySess: Request includes session cookie (tower_session_id)
    BE_VerifySess->>AxumLogin: (Implicitly via middleware) AuthSession is populated based on cookie
    AxumLogin->>TowerSessions: Load session using cookie
    TowerSessions->>SessionStore: Query "sessions" table for tower_session_id from cookie
    SessionStore-->>TowerSessions: Session data found
    TowerSessions-->>AxumLogin: Session loaded
    AxumLogin-->>BE_VerifySess: auth_session.user is Some(user)
    BE_VerifySess-->>-AC: 200 OK (JSON User/Session data)
    AC-->>-FE: User/Session data

    alt Session Invalid/Not Found (Refined Flow)
        AC->>+BE_VerifySess: GET /api/auth/session/current
        BE_VerifySess->>AxumLogin: AuthSession is populated
        AxumLogin->>TowerSessions: Load session using cookie
        TowerSessions->>SessionStore: Query "sessions" table
        SessionStore-->>TowerSessions: Session Not Found / Expired
        TowerSessions-->>AxumLogin: Session not loaded
        AxumLogin-->>BE_VerifySess: auth_session.user is None
        BE_VerifySess-->>-AC: 401/404 (JSON Error Response {"error": "No active session"})
        AC-->>-FE: Error (properly parsed)
    end
```

## 4. Benefits of this Approach

*   **Correctness:** Aligns session validation with `axum-login`'s intended mechanisms.
*   **Simplicity:** Reduces complexity on both frontend (no hashing for validation ID) and backend (handler relies on `AuthSession`).
*   **Robustness:** Ensures proper JSON error responses, allowing the frontend to handle errors gracefully.
*   **Idiomatic Code:** Leverages the features of the chosen frameworks (Axum/`axum-login` and SvelteKit) more directly.